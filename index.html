<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>My Outfits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="faviconfinal.png?v=3">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="My Outfits">


    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

   <style>
    /* CSS Reset and Global Styles */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #e4d7ff;
        color: #111827;
        padding: 0;
    }

    .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px 16px 0;
    }


    h1 {
        font-family: "Playfair Display", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 34px;
        letter-spacing: 0.03em;
        margin-bottom: 4px;
    }

    .subtitle {
        font-size: 13px;
        color: #4b5563;
        margin-bottom: 12px;
    }

    button {
        border-radius: 999px;
        border: none;
        padding: 8px 18px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
        font: inherit;
    }

    .btn-primary {
        background: #111827;
        color: #fff;
    }

    .btn-secondary {
        background: #e5e7eb;
        color: #111827;
    }

    /* 顶部工具条 */
    .toolbar {
        position: sticky;
        top: 0;
        z-index: 10;
        width: 100%;
        background: #c39eff;
        border-radius: 0;
        padding: 8px 24px;
        /* 默认电脑端 padding */
        box-shadow: 0 4px 14px rgba(15, 23, 42, 0.12);
    }

    .toolbar-inner {
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: flex-end;
    }

    .toolbar-group {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 120px;
    }

    .toolbar-label {
        font-size: 11px;
        color: #6b7280;
    }

    .toolbar select,
    .toolbar input[type="text"],
    .toolbar input[type="file"] {
        font: inherit;
        height: 32px;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
    }

    .toolbar input[type="file"] {
        padding: 2px;
        background: transparent;
        border: none;
    }

    .toolbar-buttons {
        flex-direction: row;
        gap: 6px;
    }

    .toolbar-buttons button {
        height: 32px;
        padding: 4px 14px;
        font-size: 13px;
    }

    .toolbar-note {
        flex: 2 1 220px;
    }

    /* *** 移动端优化 CSS - 进一步压缩间距 *** */
    @media (max-width: 800px) {
        .page {
            padding: 8px 16px 0;
            /* 减小标题区域顶部/侧边 padding */
        }

        .subtitle {
            margin-bottom: 8px;
            /* 减小标题区域底部间距 */
        }

        .toolbar {
            /* 重点：减小工具栏的垂直 padding */
            padding: 4px 16px 4px;
        }

        .toolbar-inner {
            /* 重点：减小内部元素行之间的间距 */
            gap: 4px; 
            padding-bottom: 4px;
            align-items: stretch;
        }

        .toolbar-group {
            /* 确保在小屏幕上垂直堆叠 */
            flex: 1 1 100%;
            min-width: unset;
            /* 重点：减小标签和输入框之间的间距 */
            gap: 1px;
        }

        .toolbar-label {
            /* 重点：减小标签的字体大小和垂直间距 */
            font-size: 10px;
            margin-top: 2px; 
        }

        .toolbar-buttons {
            flex: 1 1 100%;
            justify-content: space-between;
        }
        
        .toolbar-buttons button {
            flex: 1 1 auto;
        }
    }
    /* *** 移动端优化结束 *** */

    /* 展示区域 */
    .gallery {
        width: 100%;
        background: #f7eefe;
        padding: 0 24px 32px;
        margin-top: 0;
    }


    .gallery-inner {
        max-width: 1200px;
        margin: 0 auto;
    }

    /* 图片网格 */
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 24px;
        margin-top: 4px;
    }

    .card {
        background: transparent;
        box-shadow: none;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }

    .card img {
        width: 100%;
        aspect-ratio: 2 / 3;
        object-fit: cover;
        background: #e5e7eb;
    }

    .card-body {
        padding: 6px 2px 0;
        font-size: 13px;
    }

    .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 4px;
    }

    .tag {
        padding: 1px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #f3f4f6;
        color: #4b5563;
    }

    .note {
        font-size: 12px;
        color: #4b5563;
        margin-top: 2px;
    }

    .card-body .note+.note {
        font-size: 11px;
        color: #9ca3af;
    }

    .card-footer {
        padding: 4px 0;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    .card-footer button {
        font-size: 11px;
        padding: 4px 10px;
    }

    @media (max-width: 700px) {
        .grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }
    }
</style>
</head>

<body>
    <div class="page">
        <h1>My Outfits</h1>
        <p class="subtitle">OUTFIT IDEAS</p>
    </div>

    <div class="toolbar">
        <div class="toolbar-inner">
            <div class="toolbar-group">
                <label class="toolbar-label">选择穿搭照片</label>
                <input type="file" id="imageInput" accept="image/*" multiple />
            </div>

            <div class="toolbar-group">
                <label class="toolbar-label">季节</label>
                <select id="seasonInput">
                    <option value="">季节</option>
                    <option value="summer">summer</option>
                    <option value="winter">winter</option>
                </select>
            </div>

            <div class="toolbar-group">
                <label class="toolbar-label">场合</label>
                <select id="occasionInput">
                    <option value="">场合</option>
                    <option value="school">school</option>
                    <option value="casual">casual</option>
                    <option value="date">date</option>
                    <option value="formal">formal</option>
                    <option value="home">home</option>
                </select>
            </div>

            <div class="toolbar-group toolbar-note">
                <label class="toolbar-label">备注</label>
                <input type="text" id="noteInput" placeholder="比如：考试 outfit / 咖啡约会" />
            </div>

            <div class="toolbar-group toolbar-buttons">
                <button class="btn-primary" id="saveBtn">保存</button>
                <button class="btn-secondary" id="clearAllBtn">清空</button>
            </div>

            <div class="toolbar-group">
                <label class="toolbar-label">季节筛选</label>
                <select id="seasonFilter">
                    <option value="">全部</option>
                    <option value="summer">summer</option>
                    <option value="winter">winter</option>
                </select>
            </div>

            <div class="toolbar-group">
                <label class="toolbar-label">场合筛选</label>
                <select id="occasionFilter">
                    <option value="">全部</option>
                    <option value="school">school</option>
                    <option value="casual">casual</option>
                    <option value="date">date</option>
                    <option value="formal">formal</option>
                    <option value="home">home</option>
                </select>
            </div>
        </div>
    </div>

    <div class="gallery">
        <div class="gallery-inner">
            <div id="grid" class="grid"></div>
        </div>
        </div>

    <script>
        // --- ASYNCHRONOUS STORAGE AND COMPRESSION FUNCTIONS ---

        // 1. New function to compress and output a binary Blob (required for IndexedDB/LocalForage)
        function fileToCompressedBlob(file, maxWidth = 900) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const scale = Math.min(1, maxWidth / img.width);
                        const w = img.width * scale;
                        const h = img.height * scale;

                        const canvas = document.createElement("canvas");
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0, w, h);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error("Canvas toBlob failed"));
                            }
                        }, "image/jpeg", 0.8);
                    };
                    img.onerror = reject;
                    img.src = reader.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        const OUTFIT_LIST_KEY = "outfit_metadata_list";

        // 2. Load function updated for LocalForage (returns a Promise)
        async function loadOutfitMetadata() {
            try {
                const list = await localforage.getItem(OUTFIT_LIST_KEY);
                return list || [];
            } catch (e) {
                console.error("LocalForage metadata load error", e);
                return [];
            }
        }

        // 3. Save function updated for LocalForage (returns a Promise)
        async function saveOutfitMetadata(list) {
            try {
                await localforage.setItem(OUTFIT_LIST_KEY, list);
            } catch (e) {
                console.error("LocalForage metadata save error", e);
                alert("存储失败，可能是浏览器权限问题或空间仍不足。");
            }
        }

        // 4. 新增：更新特定 ID 的元数据
        async function updateOutfitMetadata(id, newSeason, newOccasion, newNote) {
            const list = await loadOutfitMetadata();
            const index = list.findIndex(o => o.id === id);

            if (index !== -1) {
                list[index].season = newSeason;
                list[index].occasion = newOccasion;
                // 备注也可以更新
                list[index].note = newNote;
                await saveOutfitMetadata(list);
                return true;
            }
            return false;
        }


        // --- MAIN APPLICATION LOGIC ---

        async function renderOutfits() {
            const grid = document.getElementById("grid");
            const seasonF = document.getElementById("seasonFilter").value;
            const occasionF = document.getElementById("occasionFilter").value;

            const outfits = await loadOutfitMetadata();

            grid.innerHTML = "";

            const filtered = outfits.filter(o => {
                if (seasonF && o.season !== seasonF) return false;
                if (occasionF && o.occasion !== occasionF) return false;
                return true;
            });

            if (filtered.length === 0) {
                grid.innerHTML = "<p style='font-size:13px;color:#6b7280;'>还没有符合筛选条件的穿搭，可以先上传几套</p>";
                return;
            }

            const imagePromises = filtered.map(o => localforage.getItem(o.id));
            const imageBlobs = await Promise.all(imagePromises);

            filtered.forEach((o, index) => {
                const imageBlob = imageBlobs[index];

                const card = document.createElement("div");
                card.className = "card";

                const img = document.createElement("img");

                if (imageBlob) {
                    img.src = URL.createObjectURL(imageBlob);
                    img.onload = () => {
                        URL.revokeObjectURL(img.src);
                    };
                } else {
                    img.src = "";
                    console.error(`Image Blob for ID ${o.id} not found.`);
                }

                img.alt = "outfit";
                card.appendChild(img);

                const body = document.createElement("div");
                body.className = "card-body";

                const tags = document.createElement("div");
                tags.className = "tags";

                const t1 = document.createElement("span");
                t1.className = "tag";
                t1.textContent = o.season;
                tags.appendChild(t1);

                const t2 = document.createElement("span");
                t2.className = "tag";
                t2.textContent = o.occasion;
                tags.appendChild(t2);

                body.appendChild(tags);

                if (o.note) {
                    const note = document.createElement("div");
                    note.className = "note";
                    note.textContent = o.note;
                    body.appendChild(note);
                }

                const time = document.createElement("div");
                time.className = "note";
                const d = new Date(o.createdAt);
                time.textContent = d.toLocaleString();
                body.appendChild(time);

                card.appendChild(body);

                const footer = document.createElement("div");
                footer.className = "card-footer";

                // 编辑按钮逻辑
                const editBtn = document.createElement("button");
                editBtn.textContent = "编辑";
                editBtn.className = "btn-secondary edit-btn";
                editBtn.onclick = async () => {
                    // 允许用户输入新的季节，并带上当前值作为默认值
                    const newSeason = prompt(`请输入新的季节 (当前: ${o.season}):`, o.season);

                    // 允许用户输入新的场合，并带上当前值作为默认值
                    const newOccasion = prompt(`请输入新的场合 (当前: ${o.occasion}):`, o.occasion);

                    // 允许用户输入新的备注
                    const newNote = prompt(`请输入新的备注 (当前: ${o.note || '无'}):`, o.note || '');

                    // 如果用户点击了取消，或者输入为空（但允许备注为空），则不执行更新
                    if (newSeason === null || newOccasion === null || !newSeason.trim() || !newOccasion.trim()) {
                        if (newSeason !== null || newOccasion !== null) { // 检查是否只是输入为空，而不是取消
                            alert("季节和场合不能为空！");
                        }
                        return;
                    }

                    // 执行更新操作
                    const success = await updateOutfitMetadata(o.id, newSeason.trim(), newOccasion.trim(), newNote.trim());

                    if (success) {
                        // 重新渲染，以显示新的属性
                        renderOutfits();
                    } else {
                        alert("更新失败。");
                    }
                };

                const delBtn = document.createElement("button");
                delBtn.textContent = "删除";
                delBtn.className = "btn-secondary delete-btn";

                delBtn.onclick = async () => {
                    if (!confirm("确定删除这套穿搭吗?")) return;

                    await localforage.removeItem(o.id);
                    const all = (await loadOutfitMetadata()).filter(x => x.id !== o.id);
                    await saveOutfitMetadata(all);

                    renderOutfits();
                };

                // 添加按钮到页脚
                footer.appendChild(editBtn);
                footer.appendChild(delBtn);
                card.appendChild(footer);

                grid.appendChild(card);
            });
        }

        // *** 保存逻辑保持不变 ***
        document.getElementById("saveBtn").addEventListener("click", async () => {
            const fileInput = document.getElementById("imageInput");
            const season = document.getElementById("seasonInput").value;
            const occasion = document.getElementById("occasionInput").value;
            const note = document.getElementById("noteInput").value.trim();

            if (!fileInput.files.length || !season || !occasion) {
                alert("需要照片 + 季节 + 场合");
                return;
            }

            const files = Array.from(fileInput.files);
            const list = await loadOutfitMetadata();
            const newOutfits = [];
            let successCount = 0;
            let errorCount = 0;

            try {
                const compressionAndStoragePromises = files.map(async (file) => {
                    const newId = Date.now() + "_" + Math.random().toString(16).slice(2);

                    try {
                        const imageBlob = await fileToCompressedBlob(file);
                        await localforage.setItem(newId, imageBlob);

                        newOutfits.push({
                            id: newId,
                            season,
                            occasion,
                            note,
                            createdAt: Date.now()
                        });
                        successCount++;
                    } catch (err) {
                        console.error(`处理文件 ${file.name} 失败:`, err);
                        errorCount++;
                    }
                });

                await Promise.all(compressionAndStoragePromises);

                if (newOutfits.length > 0) {
                    list.push(...newOutfits);
                    await saveOutfitMetadata(list);
                }

                if (errorCount > 0) {
                    alert(`成功保存 ${successCount} 张照片。有 ${errorCount} 张照片处理失败。`);
                } else {
                    alert(`成功保存 ${successCount} 张照片。`);
                }

                fileInput.value = "";
                document.getElementById("noteInput").value = "";
                renderOutfits();

            } catch (err) {
                console.error("整体保存操作失败:", err);
                alert("保存操作失败，请检查浏览器控制台。");
            }
        });
        // *** 保存逻辑结束 ***


        document.getElementById("clearAllBtn").addEventListener("click", async () => {
            if (confirm("确定要把所有穿搭记录清空吗？")) {
                await localforage.removeItem(OUTFIT_LIST_KEY);
                renderOutfits();
                alert("记录列表已清空。");
            }
        });

        document.getElementById("seasonFilter").addEventListener("change", renderOutfits);
        document.getElementById("occasionFilter").addEventListener("change", renderOutfits);

        renderOutfits();
    </script>
</body>

</html>

